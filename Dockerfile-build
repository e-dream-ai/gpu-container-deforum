FROM nvidia/cuda:12.4.1-cudnn-devel-ubuntu22.04

WORKDIR /workdir

# Install system dependencies first
RUN apt-get update && \
    apt-get install -y git python3-pip && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Now we can use git to clone the repository
RUN rm -rf /workdir/deforum
RUN git clone https://www.github.com/XmYx/deforum-studio deforum

WORKDIR /workdir/deforum

RUN pip install -e .[dev]

# Install additional dependencies for RunPod handler
RUN pip install runpod boto3 requests

# Uninstall and reinstall OpenCV packages as needed
RUN pip uninstall -y opencv-python opencv-python-headless
RUN pip install opencv-python-headless --force-reinstall

RUN git clone https://github.com/comfyanonymous/ComfyUI.git /workdir/deforum/src/ComfyUI
WORKDIR /workdir/deforum/src/ComfyUI
RUN git checkout daa92a8ff4d3e75a3b17bb1a6b6c508b27264ff5

WORKDIR /workdir/deforum

# Set up cache directories and environment variables for HuggingFace and model storage
ENV HF_HOME=/deforum_storage/huggingface
ENV TRANSFORMERS_CACHE=/deforum_storage/huggingface/transformers
ENV HF_DATASETS_CACHE=/deforum_storage/huggingface/datasets
ENV HUGGINGFACE_HUB_CACHE=/deforum_storage/huggingface/hub
ENV ROOT_PATH=/deforum_storage

# Create necessary cache and model directories
RUN mkdir -p /deforum_storage/huggingface/transformers \
    /deforum_storage/huggingface/datasets \
    /deforum_storage/huggingface/hub \
    /deforum_storage/models

# ——————————————————————————————————————————
# Conditionally install the Protovision model
# ——————————————————————————————————————————

# 1) Copy your entire models folder into the image (won’t fail if it’s empty)
COPY ./models /tmp/models

# 2) If the specific .safetensors file exists, move it into ComfyUI’s checkpoints
RUN if [ -f /tmp/models/protovisionXLHighFidelity3D_releaseV660Bakedvae.safetensors ]; then \
      mkdir -p /deforum_storage/models && \
      cp /tmp/models/protovisionXLHighFidelity3D_releaseV660Bakedvae.safetensors \
         /deforum_storage/models/protovisionXLHighFidelity3D_releaseV660Bakedvae.safetensors; \
    fi

# (Optional) clean up the temp copy
RUN rm -rf /tmp/models

# Copy our local src directory with handler.py and related files
COPY src/ /workdir/deforum/src/

# Copy and install the entrypoint
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# Switch to our entrypoint + keep deforum CLI as the default cmd
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["deforum", "runsingle", "--file", "/input/$SETTINGS_FILE"]


