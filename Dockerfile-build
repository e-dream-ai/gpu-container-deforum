FROM nvidia/cuda:12.4.1-cudnn-devel-ubuntu22.04

WORKDIR /workdir

# Install system dependencies first
RUN apt-get update && \
    apt-get install -y git python3-pip && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Now we can use git to clone the repository
RUN rm -rf /workdir/deforum
RUN git clone https://www.github.com/XmYx/deforum-studio deforum

WORKDIR /workdir/deforum

RUN pip install -e .[dev]

# Install RunPod SDK & utils
RUN pip install runpod boto3 requests

# Uninstall and reinstall OpenCV packages as needed
RUN pip uninstall -y opencv-python opencv-python-headless
RUN pip install opencv-python-headless --force-reinstall

# Clone ComfyUI at pinned commit
RUN git clone https://github.com/comfyanonymous/ComfyUI.git /workdir/deforum/src/ComfyUI
WORKDIR /workdir/deforum/src/ComfyUI
RUN git checkout daa92a8ff4d3e75a3b17bb1a6b6c508b27264ff5

WORKDIR /workdir/deforum

# ——————————————————————————————————————————
# Conditionally install Protovision model (if you include ./models locally)
# ——————————————————————————————————————————
COPY ./models /tmp/models
RUN if [ -f /tmp/models/protovisionXLHighFidelity3D_releaseV660Bakedvae.safetensors ]; then \
      mkdir -p /deforum_storage/models && \
      cp /tmp/models/protovisionXLHighFidelity3D_releaseV660Bakedvae.safetensors \
         /deforum_storage/models/protovisionXLHighFidelity3D_releaseV660Bakedvae.safetensors; \
    fi
RUN rm -rf /tmp/models

# ——————————————————————————————————————————
# Copy Serverless handler + predictor code
# ——————————————————————————————————————————
COPY ./src/ /workdir/deforum/src/

# Copy and install entrypoint
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# Entrypoint + default CMD
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["deforum", "runsingle", "--file", "/input/$SETTINGS_FILE"]