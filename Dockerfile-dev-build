FROM nvidia/cuda:12.4.1-cudnn-devel-ubuntu22.04

WORKDIR /workdir

RUN rm -rf /workdir/deforum

COPY sources/deforum-studio ./deforum
COPY src/*.py /workdir/deforum/src/
COPY test_input.json /workdir/deforum/

RUN apt-get update && \
    apt-get install -y git python3-pip && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

WORKDIR /workdir/deforum

RUN pip install -e .[dev]
RUN pip install runpod

# Uninstall and reinstall OpenCV packages as needed
RUN pip uninstall -y opencv-python opencv-python-headless
RUN pip install opencv-python-headless --force-reinstall

RUN git clone https://github.com/comfyanonymous/ComfyUI.git /workdir/deforum/src/ComfyUI
WORKDIR /workdir/deforum/src/ComfyUI
RUN git checkout daa92a8ff4d3e75a3b17bb1a6b6c508b27264ff5

WORKDIR /workdir/deforum

COPY test_input.json ./test_input.json

# ——————————————————————————————————————————
# Conditionally install the Protovision model
# ——————————————————————————————————————————

# 1) Copy your entire models folder into the image (won’t fail if it’s empty)
COPY ./models /tmp/models

# 2) If the specific .safetensors file exists, move it into ComfyUI’s checkpoints
RUN if [ -f /tmp/models/protovisionXLHighFidelity3D_releaseV660Bakedvae.safetensors ]; then \
      mkdir -p /deforum_storage/models && \
      cp /tmp/models/protovisionXLHighFidelity3D_releaseV660Bakedvae.safetensors \
         /deforum_storage/models/protovisionXLHighFidelity3D_releaseV660Bakedvae.safetensors; \
    fi

# (Optional) clean up the temp copy
RUN rm -rf /tmp/models

# Copy and install the entrypoint
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# 10) Expose your src folder on PYTHONPATH so `handler.py` can be imported
ENV PYTHONPATH=/workdir/src

# 11) Run via Runpod Serverless entrypoint
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["handler.handler"]